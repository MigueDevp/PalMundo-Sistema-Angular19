<div class="clients-container">
  <div class="header-section">
    <h2>Registro Global de Clientes <fa-icon [icon]="faUser" /></h2>
    <hr />

    <!-- Error message display - shows when something goes wrong -->
    @if (error()) {
    <div
      class="error-message"
      style="
        background: #ffebee;
        color: #c62828;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 15px;
        position: relative;
      "
    >
      {{ error() }}
      <button
        style="
          position: absolute;
          right: 10px;
          top: 50%;
          transform: translateY(-50%);
          background: none;
          border: none;
          cursor: pointer;
          color: #c62828;
          font-size: 16px;
        "
        (click)="error.set(null)"
      >
        √ó
      </button>
    </div>
    }

    <!-- Loading indicator - shows when data is being processed -->
    @if (isLoading) {
    <div
      class="loading-indicator"
      style="
        text-align: center;
        color: #666;
        margin-bottom: 15px;
        padding: 10px;
      "
    >
      <span style="display: inline-block; margin-right: 8px">‚è≥</span>
      Procesando...
    </div>
    }

    <!-- Add client button - disabled during loading to prevent multiple submissions -->
    <app-button-add
      (click)="openAddModal()"
      [style.opacity]="isLoading ? '0.6' : '1'"
      [style.pointer-events]="isLoading ? 'none' : 'auto'"
    >
      A√±adir Cliente
    </app-button-add>
  </div>

  <div class="table-container">
    <table class="clients-table">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Direcci√≥n</th>
          <th>Fecha de Nacimiento</th>
          <th>Tel√©fono</th>
          <th>Email</th>
          <th>Sexo</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        @if (clients().length === 0 && !isLoading) {
        <tr>
          <td
            colspan="8"
            style="
              text-align: center;
              color: #666;
              padding: 40px;
              font-style: italic;
            "
          >
            No hay clientes registrados. ¬°Agrega el primero haciendo clic en
            "A√±adir Cliente"!
          </td>
        </tr>
        } @if (isLoading && clients().length === 0) {
        <tr>
          <td
            colspan="8"
            style="text-align: center; color: #666; padding: 40px"
          >
            <span style="display: inline-block; margin-right: 8px">üîÑ</span>
            Cargando clientes...
          </td>
        </tr>
        } @for (client of clients(); track client.id_cliente) {
        <tr [style.opacity]="isLoading ? '0.7' : '1'">
          <td>
            <div class="name-container">
              <div class="client-name">{{ client.nombre }}</div>
              <div class="client-age">
                Edad: {{ calculateAge(client.fecha_nacimiento) }}
              </div>
            </div>
          </td>
          <td>{{ client.direccion }}</td>
          <td>{{ client.fecha_nacimiento | date : "yyyy-MM-dd" }}</td>
          <td>{{ client.numero_telefono }}</td>
          <td>{{ client.correo || "N/A" }}</td>
          <td>{{ client.sexo }}</td>
          <td>
            <span
              class="status-badge"
              [ngClass]="client.activo ? 'active' : 'inactive'"
            >
              <span class="status-dot"></span>
              {{ client.activo ? "Activo" : "Inactivo" }}
            </span>
          </td>

          <td class="actions">
            <app-actionsbuttons
              type="view"
              [disabled]="isLoading"
              (actionClick)="openViewModal(client)"
            ></app-actionsbuttons>

            <app-actionsbuttons
              type="edit"
              [disabled]="isLoading"
              (actionClick)="openEditModal(client)"
            ></app-actionsbuttons>

            <app-actionsbuttons
              type="delete"
              [disabled]="isLoading"
              (actionClick)="deleteClient(client.id_cliente!)"
            ></app-actionsbuttons>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>

  @if (showModal && !isEditMode) {
  <div class="modal-overlay">
    <div class="modal-content">
      <h3>Agregar Nuevo Cliente</h3>

      @if (error()) {
      <div class="error-message">
        {{ error() }}
      </div>
      }

      <form (ngSubmit)="addClient()" #addForm="ngForm">
        <div class="form-group">
          <label>Nombre completo: <span style="color: red">*</span></label>
          <input
            [(ngModel)]="newClient.nombre"
            name="nombre"
            required
            [disabled]="isLoading"
            placeholder="Ejemplo: Juan P√©rez Garc√≠a"
            #nombreField="ngModel"
          />
          @if (nombreField.invalid && nombreField.touched) {
          <small style="color: #c62828; font-size: 12px"
            >El nombre es obligatorio</small
          >
          }
        </div>

        <div class="form-group">
          <label>Fecha de nacimiento: <span style="color: red">*</span></label>
          <input
            type="date"
            [(ngModel)]="newClient.fecha_nacimiento"
            name="fechaNacimiento"
            required
            [disabled]="isLoading"
            #fechaField="ngModel"
          />
          @if (fechaField.invalid && fechaField.touched) {
          <small style="color: #c62828; font-size: 12px"
            >La fecha de nacimiento es obligatoria</small
          >
          }
        </div>

        <div class="form-group">
          <label>Direcci√≥n: <span style="color: red">*</span></label>
          <input
            [(ngModel)]="newClient.direccion"
            name="direccion"
            required
            [disabled]="isLoading"
            placeholder="Calle, n√∫mero, colonia, ciudad"
            #direccionField="ngModel"
          />
          @if (direccionField.invalid && direccionField.touched) {
          <small style="color: #c62828; font-size: 12px"
            >La direcci√≥n es obligatoria</small
          >
          }
        </div>

        <div class="form-group">
          <label>Tel√©fono: <span style="color: red">*</span></label>
          <input
            [(ngModel)]="newClient.numero_telefono"
            name="telefono"
            required
            [disabled]="isLoading"
            placeholder="10 d√≠gitos: 4421234567"
            pattern="[0-9]{10}"
            #telefonoField="ngModel"
          />
          @if (telefonoField.invalid && telefonoField.touched) {
          <small style="color: #c62828; font-size: 12px">
            @if (telefonoField.errors?.['required']) { El tel√©fono es
            obligatorio } @else if (telefonoField.errors?.['pattern']) { El
            tel√©fono debe tener exactamente 10 d√≠gitos }
          </small>
          }
        </div>

        <div class="form-group">
          <label>Email:</label>
          <input
            type="email"
            [(ngModel)]="newClient.correo"
            name="email"
            [disabled]="isLoading"
            placeholder="ejemplo@correo.com (opcional)"
            #emailField="ngModel"
          />
          @if (emailField.invalid && emailField.touched &&
          newClient.correo.trim()) {
          <small style="color: #c62828; font-size: 12px"
            >Ingresa un email v√°lido</small
          >
          }
        </div>

        <div class="form-group">
          <label>Sexo: <span style="color: red">*</span></label>
          <select
            [(ngModel)]="newClient.sexo"
            name="sexo"
            [disabled]="isLoading"
            required
          >
            <option value="Masculino">Masculino</option>
            <option value="Femenino">Femenino</option>
            <option value="Otro">Otro</option>
          </select>
        </div>

        <input
          type="hidden"
          [(ngModel)]="newClient.usuario_creacion"
          name="usuario_creacion"
        />

        <div class="modal-actions">
          <button
            type="button"
            class="cancel-btn"
            (click)="closeModal()"
            [disabled]="isLoading"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="save-btn"
            [disabled]="isLoading || addForm.invalid"
          >
            @if (isLoading) {
            <span style="display: inline-block; margin-right: 8px">‚è≥</span>
            Guardando... } @else { Guardar }
          </button>
        </div>
      </form>
    </div>
  </div>
  } @if (showModal && isViewMode && viewingClient) {
  <div class="modal-overlay">
    <div class="modal-content view-mode">
      <h3>Visualizar Cliente</h3>

      <div class="client-details">
        <!-- Informaci√≥n Personal -->
        <div class="detail-section">
          <h4>Informaci√≥n Personal</h4>
          <div class="detail-grid">
            <div class="detail-item">
              <label>Nombre completo:</label>
              <span class="detail-value">{{ viewingClient.nombre }}</span>
            </div>
            <div class="detail-item">
              <label>Fecha de nacimiento:</label>
              <span class="detail-value">{{
                viewingClient.fecha_nacimiento | date : "dd/MM/yyyy"
              }}</span>
            </div>
            <div class="detail-item">
              <label>Edad:</label>
              <span class="detail-value"
                >{{ calculateAge(viewingClient.fecha_nacimiento) }} a√±os</span
              >
            </div>
            <div class="detail-item">
              <label>Sexo:</label>
              <span class="detail-value">{{ viewingClient.sexo }}</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h4>Informaci√≥n de Contacto</h4>
          <div class="detail-grid">
            <div class="detail-item">
              <label>Direcci√≥n:</label>
              <span class="detail-value">{{ viewingClient.direccion }}</span>
            </div>
            <div class="detail-item">
              <label>Tel√©fono:</label>
              <span class="detail-value">{{
                viewingClient.numero_telefono
              }}</span>
            </div>
            <div class="detail-item">
              <label>Email:</label>
              <span class="detail-value">{{
                viewingClient.correo || "No especificado"
              }}</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h4>Informaci√≥n del Sistema</h4>
          <div class="detail-grid">
            <div class="detail-item">
              <label>ID Cliente:</label>
              <span class="detail-value">{{ viewingClient.id_cliente }}</span>
            </div>
            <div class="detail-item">
              <label>Estado:</label>
              <span class="detail-value">
                <span
                  class="status-badge"
                  [ngClass]="viewingClient.activo ? 'active' : 'inactive'"
                >
                  <span class="status-dot"></span>
                  {{ viewingClient.activo ? "Activo" : "Inactivo" }}
                </span>
              </span>
            </div>
            <div class="detail-item">
              <label>Fecha de creaci√≥n:</label>
              <span class="detail-value">{{
                viewingClient.fecha_creacion | date : "dd/MM/yyyy HH:mm"
              }}</span>
            </div>
            @if (viewingClient.fecha_modificacion) {
            <div class="detail-item">
              <label>√öltima modificaci√≥n:</label>
              <span class="detail-value">{{
                viewingClient.fecha_modificacion | date : "dd/MM/yyyy HH:mm"
              }}</span>
            </div>
            }
            <div class="detail-item">
              <label>Creado por:</label>
              <span class="detail-value">{{
                viewingClient.usuario_creacion || "Sistema"
              }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="cancel-btn" (click)="closeModal()">
          Cerrar
        </button>
        <button
          type="button"
          class="edit-btn"
          (click)="openEditModal(viewingClient!)"
        >
          ‚úèÔ∏è Editar Cliente
        </button>
      </div>
    </div>
  </div>
  } @if (showModal && isEditMode && editingClient) {
  <div class="modal-overlay">
    <div class="modal-content">
      <h3>Editar Cliente</h3>

      @if (error()) {
      <div class="error-message">
        {{ error() }}
      </div>
      }

      <form (ngSubmit)="updateClient()" #editForm="ngForm">
        <div class="form-group">
          <label>Nombre completo: <span style="color: red">*</span></label>
          <input
            [(ngModel)]="editingClient.nombre"
            name="nombre"
            required
            [disabled]="isLoading"
            placeholder="Ejemplo: Juan P√©rez Garc√≠a"
            #nombreField="ngModel"
          />
          @if (nombreField.invalid && nombreField.touched) {
          <small style="color: #c62828; font-size: 12px"
            >El nombre es obligatorio</small
          >
          }
        </div>

        <div class="form-group">
          <label>Fecha de nacimiento: <span style="color: red">*</span></label>
          <input
            type="date"
            [(ngModel)]="editingClient.fecha_nacimiento"
            name="fechaNacimiento"
            required
            [disabled]="isLoading"
            #fechaField="ngModel"
          />
          @if (fechaField.invalid && fechaField.touched) {
          <small style="color: #c62828; font-size: 12px"
            >La fecha de nacimiento es obligatoria</small
          >
          }
        </div>

        <div class="form-group">
          <label>Direcci√≥n: <span style="color: red">*</span></label>
          <input
            [(ngModel)]="editingClient.direccion"
            name="direccion"
            required
            [disabled]="isLoading"
            placeholder="Calle, n√∫mero, colonia, ciudad"
            #direccionField="ngModel"
          />
          @if (direccionField.invalid && direccionField.touched) {
          <small style="color: #c62828; font-size: 12px"
            >La direcci√≥n es obligatoria</small
          >
          }
        </div>

        <div class="form-group">
          <label>Tel√©fono: <span style="color: red">*</span></label>
          <input
            [(ngModel)]="editingClient.numero_telefono"
            name="telefono"
            required
            [disabled]="isLoading"
            placeholder="10 d√≠gitos: 4421234567"
            pattern="[0-9]{10}"
            #telefonoField="ngModel"
          />
          @if (telefonoField.invalid && telefonoField.touched) {
          <small style="color: #c62828; font-size: 12px">
            @if (telefonoField.errors?.['required']) { El tel√©fono es
            obligatorio } @else if (telefonoField.errors?.['pattern']) { El
            tel√©fono debe tener exactamente 10 d√≠gitos }
          </small>
          }
        </div>

        <div class="form-group">
          <label>Email:</label>
          <input
            type="email"
            [(ngModel)]="editingClient.correo"
            name="email"
            [disabled]="isLoading"
            placeholder="ejemplo@correo.com (opcional)"
            #emailField="ngModel"
          />
          @if (emailField.invalid && emailField.touched &&
          editingClient.correo.trim()) {
          <small style="color: #c62828; font-size: 12px"
            >Ingresa un email v√°lido</small
          >
          }
        </div>

        <div class="form-group">
          <label>Sexo: <span style="color: red">*</span></label>
          <select
            [(ngModel)]="editingClient.sexo"
            name="sexo"
            [disabled]="isLoading"
            required
          >
            <option value="Masculino">Masculino</option>
            <option value="Femenino">Femenino</option>
            <option value="Otro">Otro</option>
          </select>
        </div>

        <div class="form-group">
          <label>Estado:</label>
          <div class="checkbox-group">
            <label>
              <input
                type="checkbox"
                [(ngModel)]="editingClient.activo"
                name="activo"
                [disabled]="isLoading"
              />
              Cliente activo
            </label>
          </div>
        </div>

        <div class="modal-actions">
          <button
            type="button"
            class="cancel-btn"
            (click)="closeModal()"
            [disabled]="isLoading"
          >
            Cancelar
          </button>
          <button
            type="submit"
            class="save-btn"
            [disabled]="isLoading || editForm.invalid"
          >
            @if (isLoading) {
            <span style="display: inline-block; margin-right: 8px">‚è≥</span>
            Actualizando... } @else { Actualizar }
          </button>
        </div>
      </form>
    </div>
  </div>
  }
</div>
